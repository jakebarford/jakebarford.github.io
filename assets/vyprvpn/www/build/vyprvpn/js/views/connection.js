function VyprConnection(){this.constants.message={login:{error:{fail:"Incorrect username or password.",network:"Network error. Please try again later."},warning:{username:"Invalid username or password.",password:"Invalid username or password.",support:"Your account does not support the OpenVPN Protocol. Please contact VyprVpnRouterBeta@goldenfrog.com for complimentary access."}}},this.g_pings=null,this.g_servers=this.getCache("servers"),this.g_ping_status_interval=void 0,this.g_ping_status_delay=1,this.g_ping_status_limit=3,this.g_ping_status_count=0,this.g_enable_fields_ids.push("vypr--username"),this.g_enable_fields_ids.push("vypr--password"),this.g_enable_fields_ids.push("vypr--login-button"),this.g_enable_fields_ids.push("vypr--select-server"),this.g_enable_fields_ids.push("vypr--select-protocol"),this.g_enable_fields_ids.push("vypr--connect-button"),this.g_enable_fields_ids.push("vypr--disconnect-button"),this.g_enable_fields_ids.push("connection-pingbutton"),this.g_enable_fields_ids.push("vypr-select-server-label"),this.g_enable_fields_ids.push("vypr-select-protocol-label"),this.g_enable_fields_ids.push("vypr-server-table"),this.g_enable_fields_ids.push("vypr-protocol-table")}String.prototype.toClassName=function(){return this.replace(/\s/g,"-").toLowerCase()},VyprElementHelper.triggerEvent=function(a,b,c){if(c||(c=document),c.createEvent)try{e=new Event(b),a.dispatchEvent(e)}catch(d){e=c.createEvent("Event"),e.initEvent(b,!0,!0),a.dispatchEvent(e)}else e=c.createEventObject(),a.fireEvent("on"+b,e)},VyprElementHelper.iniSelect=function(a){var b="string"==typeof a?document.getElementById(a):a,c=b.selectedIndex;b.selectedIndex=c+1,b.options[c].removeAttribute("selected"),b.options[c+1].setAttribute("selected","selected"),b.selectedIndex=c,b.options[c+1].removeAttribute("selected"),b.options[c].setAttribute("selected","selected")},VyprElementHelper.sendEvent=function(a,b){var c,d="string"==typeof a?document.getElementById(a):a;document.createEvent?(c=document.createEvent("HTMLEvents"),c.initEvent(b,!0,!0)):(c=document.createEventObject(),c.eventType=b),c.eventName=b,document.createEvent?d.dispatchEvent(c):d.fireEvent("on"+c.eventType,c)},VyprElementHelper.getPageOffset=function(a){for(var b="string"==typeof a?document.getElementById(a):a,c=b.offsetLeft,d=b.offsetTop;b=b.offsetParent;)c+=b.offsetLeft,d+=b.offsetTop;return{left:c,top:d}},VyprElementHelper.hasScrollbar=function(a){var b="string"==typeof a?document.getElementById(a):a;return b.clientHeight<b.scrollHeight},VyprConnection.prototype=new Vypr,VyprConnection.prototype.requestLogin=function(a,b){var c=this.verifyFields();if(!c)return!1;var d=this,e=this.doRequest(["VYPRVPN_LOGIN",a,b],this.handleLoginResponse,function(a){log.error("Error in requestLogin(): ",a),d.handleStatus("LOGIN_FAILED")});e&&(this.clearMessages(),log.status("Requesting login..."),this.setCache("app_status","LOGGING_IN"),this.handleStatus("LOGGING_IN"))},VyprConnection.prototype.requestGetServers=function(a){var b=this,c=this.doRequest(["VYPRVPN_GET_SERVERS"],this.handleGetServersResponse,function(a){log.error("Error in requestGetServers(): ",a),b.enableFields(!0)});c&&(log.status("Getting available servers..."),a||this.enableFields(!1))},VyprConnection.prototype.requestPingStart=function(){var a=this.doRequest(["VYPRVPN_PING_START"],this.handlePingStartResponse,function(a){log.error("Error in requestPingStart(): ",a)});a&&log.status("Sending ping start command...")},VyprConnection.prototype.requestPingStatus=function(){var a=this.doRequest(["VYPRVPN_PING_STATUS"],this.handlePingStatusResponse,function(a){log.error("Error in requestPingStatus(): ",a)});a?log.status("Requesting ping status..."):log.warn("Failed to request ping status.")},VyprConnection.prototype.handleStatus=function(a){switch(Vypr.prototype.handleStatus.apply(this,arguments),a){case"LOGGED_IN":case"CONNECTED":case"CONNECT_FAILED":null===this.g_servers&&(log.status("Retrieving server list..."),this.requestGetServers())}},VyprConnection.prototype.handleConnectResponse=function(a){Vypr.prototype.handleConnectResponse.apply(this,arguments),this.updateServers()},VyprConnection.prototype.handleDisconnectResponse=function(a){Vypr.prototype.handleDisconnectResponse.apply(this,arguments),this.updateServers()},VyprConnection.prototype.handleLoginResponse=function(a){var b=this.parseResponse(a),c=document.getElementById("vypr-login-form");return"FAIL"==b.res?("INVALID_CREDENTIALS"==b.reason?(this.setVyprError(this.constants.message.login.error.fail,c),log.error("Incorrect username or password.",b.reason)):"NO_SUPPORTED_PROTOCOLS"==b.reason?(this.setLoginWarning(this.constants.message.login.warning.support,c),log.error("Account does not support OpenVPN.",b.reason)):"NETWORK_ERROR"==b.reason?(this.setVyprError(this.constants.message.login.error.network,c),log.error("Network error on login.",b.reason)):this.handleFailResponse(a),void this.enableFields(!0)):(log.success("Login succesful."),this.g_servers=b.servers,this.setCache("servers",b.servers),this.populateServers(),void 0)},VyprConnection.prototype.handleGetServersResponse=function(a){var b=this.parseResponse(a);return this.enableFields(!0),"FAIL"==b.res?void this.handleFailResponse(a):(log.success("Got servers."),this.g_servers=b.servers,this.setCache("servers",b.servers),this.populateServers(),this.populateConnection(),void 0)},VyprConnection.prototype.handlePingStartResponse=function(a){var b=this.parseResponse(a);return"FAIL"==b.res?void this.handleFailResponse(a):(log.success("Ping start command executed."),void this.startPingTimer())},VyprConnection.prototype.handlePingStatusResponse=function(a){var b=this.parseResponse(a);return"FAIL"==b.res?void this.handleFailResponse(a):(log.success("Ping status received."),this.g_pings=b.data,this.populatePings(),(this.isPingStatusAtLimit()||this.isPingDataComplete())&&this.stopPingTimer(),void 0)},VyprConnection.prototype.startPingTimer=function(){var a=this;void 0===this.g_ping_status_interval&&(log.status("Attempting ping status requests..."),a.requestPingStatus(),a.g_ping_status_interval=window.setInterval(function(){a.requestPingStatus(),a.g_ping_status_count++},1e3*a.g_ping_status_delay))},VyprConnection.prototype.stopPingTimer=function(){void 0!==this.g_ping_status_interval&&(this.g_ping_status_interval=window.clearInterval(this.g_ping_status_interval),log.status("Terminated ping status requests."))},VyprConnection.prototype.resetPingTimer=function(){this.g_pings=0,this.g_ping_status_count=0,log.status("Ping status reset.")},VyprConnection.prototype.isPingStatusAtLimit=function(){return this.g_ping_status_count>=this.g_ping_status_limit/this.g_ping_status_delay},VyprConnection.prototype.isPingDataComplete=function(){return!(!this.g_pings||!this.g_servers)&&Object.keys(this.g_pings).length===Object.keys(this.g_servers).length},VyprConnection.prototype.populateLogin=function(a){document.getElementById("vypr--username").value=a||this.getCache("user")},VyprConnection.prototype.populateServers=function(){var a=document.getElementById("vypr--select-server"),b=document.getElementById("vypr--select-protocol"),c=this.getConnectionData(),d=c[0],e=c[3];c[4];if(null===this.g_servers)return VyprElementHelper.emptyNode(a),void VyprElementHelper.emptyNode(b);var f=this.buildServersOptionsArray(),g=d||this.getCache("location"),h=VyprElementHelper.buildOptions(f,g),i=this.buildProtocolsOptionsArray(),j=e||this.getCache("protcol"),k=VyprElementHelper.buildOptions(i,j),l=!0;VyprElementHelper.appendChildArray(a,h,l),VyprElementHelper.appendChildArray(b,k,l),this.populateServerSelector(),this.populateProtocolSelector(),this.updateServers(),this.updateScrollpane()},VyprConnection.prototype.populateServerSelector=function(){var a,b,c=!0,d=this.buildServersArray(),e=document.getElementById("vypr-server-table-item-tpl"),f=document.getElementById("vypr-server-table-item-container"),g=[],h={nation:"vypr-server-table-item-nation-X"},i={tpl:"vypr-server-table-item-tpl",icon:"vypr-server-table-item-icon-X"},j=[],k={},l={name:"",countryCode:""};if(!e||!f)return void log.warn("Not populating servers, because elements were not found.");for(a=0,b=d.length;a<b;++a)j=d[a],l.name=j[0],l.countryCode=j[1],k={textBinds:{},attrBinds:{},classNames:[]},k.textBinds[h.nation]=l.name,k.attrBinds[i.tpl]={id:l.name.toClassName()||i.tpl},k.attrBinds[i.icon]={"data-vypr-server":l.countryCode,alt:l.name},g.push(k);this.populateTemplate(e,f,g,this.constants.re.stringReplace,c)},VyprConnection.prototype.populateProtocolSelector=function(a){var b,c,d=!0,e=this.buildProtocolsArray(a),f=document.getElementById("vypr-protocol-table-item-tpl"),g=document.getElementById("vypr-protocol-table-item-container"),h=[],i={},j={name:"vypr-protocol-table-item-name-X",description:"vypr-protocol-table-item-description-X"},k={name:"",description:""};if(!f||!g)return void log.warn("Not populating protocols, because elements were not found.");for(b=0,c=e.length;b<c;++b)i=e[b],k.name=i[1],k.description=i[2],i={textBinds:{},attrBinds:{},classNames:[]},i.textBinds[j.name]=k.name,i.textBinds[j.description]=k.description,h.push(i);this.populateTemplate(f,g,h,this.constants.re.stringReplace,d)},VyprConnection.prototype.populateTemplate=function(a,b,c,d,e){var f,g,h,i,j={items:[],item:null,bind:null},k="",l="",m="",n={},o="",p="",q="",r=void 0!==typeof d,s={},t=void 0;for(f=0,g=c.length;f<g;++f){for(s=c[f],k=f.toString(),j.item=a.cloneNode(!0),q=j.item.id,h=0,i=s.classNames.length;h<i;++h)p=s.classNames[h],VyprElementHelper.addClass(j.item,p);for(l in s.attrBinds)if(s.attrBinds.hasOwnProperty(l)){j.bind=VyprElementHelper.getElementById(j.item,l),n=s.attrBinds[l],j.bind||l!==j.item.id||(j.bind=j.item);for(o in n)n.hasOwnProperty(o)&&(m=n[o],t=j.bind.getAttribute(o)||"",t.search(d)>-1?j.bind.setAttribute(o,t.replace(d,m)):j.bind.setAttribute(o,m))}for(l in s.textBinds)s.textBinds.hasOwnProperty(l)&&(m=s.textBinds[l],j.bind=VyprElementHelper.getElementById(j.item,l),r&&(j.bind.id=j.bind.id.replace(d,k)),VyprElementHelper.setTextContent(j.bind,m));r&&j.item.id===q&&(j.item.id=j.item.id.replace(d,k)),j.item.removeAttribute("hidden"),j.items.push(j.item)}VyprElementHelper.appendChildArray(b,j.items),e&&a.parentNode.removeChild(a),this.setEventHandlers()},VyprConnection.prototype.populatePings=function(){var a,b,c=this.g_pings,d="",e={prefix:"vypr--unitdisplay-",wrap:"vypr--unitdisplay",data:"vypr--unitdisplay-data",item:"vypr--selecttable-item",label:"vypr--selecttable-item-label"},f={item:null,items:VyprElementHelper.getElementsByClassName("vypr-server-table",e.item),pingData:null,pingWrap:null,itemLabel:null},g="",h="",i="",j=this.isPingStatusAtLimit()||this.isPingDataComplete(),k=function(a){var b="unknown";return 0!==a&&!a||a<0?b:(a>=300&&(b="bad"),a>149&&a<=299&&(b="average"),a<=149&&(b="good"),b)};for(a=0,b=f.items.length;a<b;a++)f.item=f.items[a],f.itemLabel=VyprElementHelper.getElementsByClassName(f.item,e.label)[0],g=VyprElementHelper.getTextContent(f.itemLabel),d=c?c[g]:d,f.pingData=VyprElementHelper.getElementsByClassName(f.item,e.data)[0],f.pingWrap=VyprElementHelper.getElementsByClassName(f.item,e.wrap)[0],i=k(d),h=e.prefix+i,d&&VyprElementHelper.setTextContent(f.pingData,d),("unknown"!==i||"unknown"===i&&j)&&(VyprElementHelper.addClass(f.pingWrap,h),VyprElementHelper.addClass(f.pingWrap,this.constants.className.active))},VyprConnection.prototype.resetPingData=function(){if(null!==this.g_pings){var a,b,c=(this.g_pings,"&mdash;"),d={prefix:new RegExp("vypr--unitdisplay-([a-z]+)"),data:"vypr--unitdisplay-data",wrap:"vypr--unitdisplay",item:"vypr--selecttable-item"},e={item:null,items:VyprElementHelper.getElementsByClassName("vypr-server-table",d.item),pingData:null,pingWrap:null};for(a=0,b=e.items.length;a<b;a++)e.item=e.items[a],e.pingData=VyprElementHelper.getElementsByClassName(e.item,d.data)[0],e.pingWrap=VyprElementHelper.getElementsByClassName(e.item,d.wrap)[0],e.pingData.innerHTML=c,e.pingWrap.className=e.pingWrap.className.replace(d.prefix,""),VyprElementHelper.removeClass(e.pingWrap,this.constants.className.active)}},VyprConnection.prototype.buildServersOptionsArray=function(){if(null===this.g_servers)return[];var a,b,c=[],d=this.g_servers;for(a=0,b=d.length;a<b;a++)c.push([d[a].name,d[a].name]);return c},VyprConnection.prototype.buildServersArray=function(){if(null===this.g_servers)return[];var a=[],b=this.g_servers;for(i=0;i<b.length;i++)a.push([b[i].name||"",b[i].country_code.toLowerCase()||""]);return a},VyprConnection.prototype.buildProtocolsArray=function(a){return this.buildProtocolsOptionsArray(a)},VyprConnection.prototype.buildProtocolsOptionsArray=function(a){if(null===this.g_servers)return[];a=a||0;var b=[],c=this.g_servers[a].protocols,d=this.g_protocol_text;for(var e in d)c.indexOf(e)>-1&&b.push([e,d[e].name,d[e].description]);return b},VyprConnection.prototype.updateServers=function(){var a=document.getElementById("vypr--select-server"),b=document.getElementById("vypr--select-protocol"),c=this.getConnectionData(),d=c[0],e=c[3];VyprElementHelper.setSelectedIndexByValue(a,d),VyprElementHelper.setSelectedIndexByValue(b,e),setTimeout(function(){VyprElementHelper.sendEvent(b,"change")})},VyprConnection.prototype.updatePingButtonWidth=function(){var a=document.getElementById("connection-pingbutton"),b=parseInt(VyprElementHelper.css(a,"width").replace("px",""),10),c=b+this.constants.scrollbarWidth,d=2;a.style.width=(c-d).toString()+"px"},VyprConnection.prototype.verifyFields=function(a){var b=this,a=a;if(isValid=!1,isUsername=!1,isPassword=!1,validationMethods={username:function(a){var c=a.value.trim(),d=Boolean(c);return d?b.clearInvalidClass(a):b.setInvalidClass(a,"Invalid message."),d},password:function(a){var c=a.value.trim(),d=Boolean(c);return d?b.clearInvalidClass(a):b.setInvalidClass(a,"Invalid email."),d}},a){if(isUsername=0===a.id.search("vypr--username"),isPassword=0===a.id.search("vypr--password"),isUsername)return isValid=validationMethods.username(a),isValid||this.setElementStatus(a,"warning"),isValid;if(isPassword)return isValid=validationMethods.password(a),isValid||this.setElementStatus(a,"warning"),isValid}else a=document.getElementById("vypr--username"),validationMethods.username(a),a=document.getElementById("vypr--password"),validationMethods.password(a);return!0},VyprConnection.prototype.setEventHandlers=function(){function a(a){b.handleEnter.apply(b,[a,function(){b.handleLoginFormSend.apply(b)}])}var b=this,c=document.getElementById("vypr--select-server"),d=document.getElementById("vypr--select-protocol");0===this.g_events_handled_count?(Vypr.prototype.setEventHandlers.apply(this),document.getElementById("vypr--username").addEventListener("keypress",a,!1),document.getElementById("vypr--password").addEventListener("keypress",a,!1),document.getElementById("vypr--login-button").addEventListener("click",function(){b.handleLoginFormSend.apply(b)},!1),document.getElementById("connection-pingbutton").addEventListener("click",function(){var a=document.getElementById("vypr-server-table"),c=b.constants.className.active;VyprElementHelper.hasClass(a,c)?(VyprElementHelper.removeClass(a,c),b.stopPingTimer(),b.resetPingTimer(),b.resetPingData()):(VyprElementHelper.addClass(a,c),b.requestPingStart())},!1),window.addEventListener("resize",function(){b.updateScrollpane.apply(b)}),window.addEventListener("scroll",function(){b.updateScrollpane.apply(b)}),c.addEventListener("change",function(){var a=b.getConnectionCountryCode(this.value);b.messageSendToFramePage("vypr.dom.set.connection.location",{location:this.value,locationIcon:a})}),d.addEventListener("change",function(){b.messageSendToFramePage("vypr.dom.set.connection.protocol",{protocol:this.value})})):(this.handleSelect(VyprElementHelper.getElementsByClassName("vypr-server-table-item-container","vypr--selecttable-item"),c,[{for:"vypr-select-server-label-icon",type:"attribute",attribute:"data-vypr-server",fromClass:"vypr--selecttable-icon"},{for:"vypr-select-server-label-icon",type:"attribute",attribute:"alt",fromClass:"vypr--selecttable-icon"},{for:"vypr-select-server-label-text",type:"text",fromClass:"vypr--selecttable-item-label"}]),this.handleSelect(VyprElementHelper.getElementsByClassName("vypr-protocol-table-item-container","vypr--selecttable-item"),d,[{for:"vypr-select-protocol-label-text",type:"text",fromClass:"vypr--selecttable-item-label"}])),this.g_events_handled_count++,this.handleFieldFocus()},Vypr.prototype.handleLoginFormSend=function(){var a={username:document.getElementById("vypr--username"),password:document.getElementById("vypr--password")},b={username:a.username.value.trim(),password:a.password.value.trim()},c={username:this.verifyFields(a.username),password:this.verifyFields(a.password)},d=document.getElementById("vypr-login-form");return this.clearMessages(d),c.username&&c.password?void this.requestLogin(b.username,b.password):(this.setVyprWarning(this.constants.message.login.warning.password,d,"vypr-login-form"),void log.warn("Invalid form data"))},Vypr.prototype.handleSelect=function(a,b,c){var d,e,f,g,h=this,i=b.selectedIndex,j=function(a,b){var c,d,e={},f=void 0;if(b.length)for(c=0,d=b.length;c<d;++c)switch(e=b[c],e.type){case"attribute":f=VyprElementHelper.getElementsByClassName(a,e.fromClass)[0].getAttribute(e.attribute),document.getElementById(e.for).setAttribute(e.attribute,f);break;case"text":f=VyprElementHelper.getTextContent(VyprElementHelper.getElementsByClassName(a,e.fromClass)[0]),VyprElementHelper.setTextContent(document.getElementById(e.for),f)}},k={item:null,option:null};for(d=0,e=a.length;d<e;++d)k.item=a[d],VyprElementHelper.removeClass(k.item,h.constants.className.active),d===i&&(VyprElementHelper.addClass(k.item,h.constants.className.active),j(k.item,c)),k.item.addEventListener("click",function(a){var d="disabled"===b.getAttribute("disabled"),e=VyprElementHelper.getIndex(this);if(!d){for(f=0,g=this.parentNode.childNodes.length;f<g;++f)b.options[f].removeAttribute("selected"),VyprElementHelper.removeClass(this.parentNode.childNodes[f],h.constants.className.active);b.selectedIndex=e,b.options[e].setAttribute("selected","selected"),VyprElementHelper.triggerEvent(b,"change"),VyprElementHelper.addClass(this,h.constants.className.active),j(this,c)}},!1),b.addEventListener("change",function(c){var d="disabled"===b.getAttribute("disabled"),e=this.selectedIndex,i=b.previousSibling.getElementsByTagName("var")[0];if(!d){for(f=0,g=a.length;f<g;++f)VyprElementHelper.removeClass(a[f],h.constants.className.active);VyprElementHelper.addClass(a[e],h.constants.className.active),VyprElementHelper.setTextContent(i,VyprElementHelper.getTextContent(this.options[e]))}},!1)},Vypr.prototype.handleFieldFocus=function(){for(var a=this,b=document.getElementById("vypr-login-form"),c=b.querySelectorAll('[data-vypr-role="field"]'),d=0;d<c.length;++d){var e=c[d];e.addEventListener("change",function(c){a.removeMessage("vypr-login-form",b)},!1)}},VyprConnection.prototype.init=function(){Vypr.prototype.init.apply(this,arguments),this.populateLogin(),this.constants.scrollbarWidth=window.getScrollBarWidth(),this.updatePingButtonWidth()},VyprVPN=new VyprConnection,VyprVPN.init();